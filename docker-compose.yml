services:
  # Backend - NOT exposed to internet
  backend:
    build: ./backend
    volumes:
      - ./backend/dataset:/app/dataset
      - huggingface_cache:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - DEVICE=cuda
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG_MODE=true
      - DEFAULT_MODEL_ID=controlnet_scribble
      - NUM_INFERENCE_STEPS=20
      - GUIDANCE_SCALE=7.5
      - OUTPUT_IMAGE_SIZE=512
    networks:
      - sketch2image

  # Express proxy server - ONLY this is exposed
  app:
    build: 
      context: .
      dockerfile: proxy-server/Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - backend
    environment:
      - BACKEND_URL=http://backend:8000
      - NODE_ENV=production
    networks:
      - sketch2image

volumes:
  huggingface_cache: {}

networks:
  sketch2image:
    driver: bridge